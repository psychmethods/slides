---
title: "Confidence Intervals <br> `r emo::ji('cactus')`"
author: "S. Mason Garrison"
bibliography: "library.bib"
output:
  xaringan::moon_reader:
    css: "../slides.css"
    lib_dir: libs
    self_contained: TRUE
    nature:
      ratio: "16:9"
      highlightLines: true
      highlightStyle: solarized-light
      countIncrementalSlides: false
      slideNumberFormat: ""
---

```{r child = "../setup.Rmd"}
```

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
# Remember to compile
#xaringan::inf_mr(cast_from = "..")
#       slideNumberFormat: ""  
library(tidyverse)
if (!require("emo")) devtools::install_github("hadley/emo")
# Installs library if missing
library(emo)
knitr::opts_chunk$set(echo = FALSE,out.width = "90%", fig.align = "center")
library(psych)
if (!requireNamespace("plotly", quietly = TRUE)) install.packages("plotly")
library(plotly)
```

class: middle

# Confidence Intervals

---

# Confidence Intervals (CI)

.pull-left[
- Sample statistics estimate population parameters
- How confident are we in these estimations?
]
--

.pull-right[
- Confidence interval
  - range around sample statistic in which the corresponding population parameter is estimated to be.
]

---

# Confidence Intervals (CI)

.pull-left[
- Sample statistics typically deviate from actual population parameters
- Wake students, n = 100; MIQ = 136
- Is mean Wake IQ really 136?
]
--

.pull-right[
- Confidence interval: 
  - Given sample size and statistic,
  - we're X% confident that the population parameter is within this range
]
---

# Confidence Intervals (CI)

- CIs are computed with specific percentages
- Most common: 95% confidence interval


> “…sample mean of 5.5, 95% CI[4.2, 6.8]…”

--

<br>

> “If the study were repeated with different samples, the population mean would fall within the interval 95% of the time.”


---

## Demo: Confidence Interval Coverage

- We will show a single-sample CI, 
  - coverage across replicates, and 
  - how CI width changes with n and confidence.

```{r ci-demo, echo=FALSE, out.width="90%"}
set.seed(1234)
library(plotly)
library(ggplot2)

one_ci <- function(n = 30, conf = 0.95,
                    mu=100,
                    sigma = 15
                   ) {
 
  alpha <- 1 - conf
  z_crit <- qnorm(1 - alpha / 2)
  
  sample_data <- rnorm(n, mean = mu, sd = sigma)
  sample_mean <- mean(sample_data)
  sample_se <- sigma / sqrt(n)
  
  lower_bound <- sample_mean - z_crit * sample_se
  upper_bound <- sample_mean + z_crit * sample_se
  
  data.frame(
    SampleMean = sample_mean,
    LowerBound = lower_bound,
    UpperBound = upper_bound,
    ContainsMu = (lower_bound <= mu) & (upper_bound >= mu)
  )
}
ci_simulation <- function(n = 30, conf = 0.95, reps = 100) {
  ci_results <- replicate(reps, one_ci(n, conf), simplify = FALSE)
  do.call(rbind, ci_results)
}

ci_data <- ci_simulation(n = 30, conf = 0.95, reps = 100) %>% 
  mutate(SampleIndex = 1:n(),
         ContainsMu = as.factor(ContainsMu),
         UpperBound = round(UpperBound, 2),
         LowerBound = round(LowerBound, 2),
         SampleMean = round(SampleMean, 2))

ci_plot <- ggplot(ci_data, aes(x = SampleIndex)) +
  geom_errorbar(aes(ymin = LowerBound, ymax = UpperBound, color = ContainsMu), width = 0.2) +
  geom_point(aes(y = SampleMean), size = 2) +
  geom_hline(yintercept = 100, linetype = "dashed", color = "red") +
  labs(title = "Confidence Interval Coverage Simulation",
       x = "Sample Index",
       y = "Value") +
  scale_color_manual(values = c("TRUE" = "blue", "FALSE" = "orange"), 
                     labels = c("Contains Mu", "Does Not Contain Mu")) +
  theme_minimal()

ggplotly(ci_plot)
```


```{r}
set.seed(123)

# Parameters aligned with narrative

true_mu <- 98
true_sd <- 15
n <- 100
conf <- 0.95
n_draws <- 200

alpha <- 1 - conf
tcrit <- qt(1 - alpha/2, df = n - 1)
tcrit_se <- tcrit * (true_sd / sqrt(n))
# Simulate samples and compute t CIs for the mean

sim <- replicate(n_draws, rnorm(n, mean = true_mu, sd = true_sd), simplify = FALSE)
stats <- lapply(seq_along(sim), function(k){
x <- sim[[k]]
m <- mean(x); s <- sd(x); se <- s / sqrt(n)
lo <- m - tcrit_se; hi <- m + tcrit_se
data.frame(draw = k, mean = m, lo = lo, hi = hi,
contains_mu = as.integer(lo <= true_mu & hi >= true_mu))
}) |> dplyr::bind_rows()

coverage_running <- stats |>
dplyr::arrange(draw) |>
dplyr::mutate(covered_cum = cumsum(contains_mu)/draw)

# Axis context

xlim <- c(true_mu - 4*true_sd, true_mu + 4*true_sd)
dens_x <- seq(xlim[1], xlim[2], length.out = 400)
dens_y <- dnorm(dens_x, mean = true_mu, sd = true_sd)

# Base plot with normal curve and reference line

p <- plotly::plot_ly() |>
plotly::add_lines(x = dens_x, y = dens_y, hoverinfo = "skip",
line = list(width = 1), showlegend = FALSE, yaxis = "y2") |>
plotly::add_line(x = true_mu, line = list(dash = "dot"), showlegend = FALSE)

# Build animation frames

frames <- lapply(seq_len(nrow(stats)), function(k){
row <- stats[stats$draw == k, ]
cov_now <- coverage_running$covered_cum[k]
list(
name = as.character(k),
data = list(
list(type = "scatter", mode = "lines",
x = c(row$lo, row$hi), y = c(0, 0), yaxis = "y",
hoverinfo = "text",
text = sprintf("draw %dmean = %.2fCI = [%.2f, %.2f]%s",
k, row$mean, row$lo, row$hi,
ifelse(row$contains_mu == 1, "contains 98", "misses 98")),
line = list(width = 6, color = if (row$contains_mu == 1) "rgba(0,0,0,0.75)" else "rgba(200,0,0,0.9)")
),
list(type = "scatter", mode = "markers",
x = row$mean, y = 0, yaxis = "y",
marker = list(size = 10, symbol = "x", line = list(width = 2)),
hoverinfo = "text",
text = sprintf("sample mean = %.2f", row$mean)
),
list(type = "scatter", mode = "text",
x = xlim[1] + 0.02_diff(xlim), y = max(dens_y)_0.9, yaxis = "y2",
text = sprintf("coverage: %.1f%% target: %.0f%% draw %d of %d",
100_cov_now, 100_conf, k, nrow(stats)),
textposition = "top left",
showlegend = FALSE,
hoverinfo = "skip"
)
)
)
})

# Initial traces

k1 <- frames[[1]]$data
p <- p |>
plotly::add_trace(k1[[1]]) |>
plotly::add_trace(k1[[2]]) |>
plotly::add_trace(k1[[3]]) |>
plotly::layout(
title = list(text = sprintf("95%% t CI for μ; n = %d", n)),
xaxis = list(title = "IQ", range = xlim, zeroline = FALSE),
yaxis = list(title = "", showticklabels = FALSE, zeroline = FALSE),
yaxis2 = list(overlaying = "y", side = "right", showticklabels = FALSE, title = "", zeroline = FALSE),
shapes = list(list(type = "line", x0 = true_mu, x1 = true_mu, y0 = 0, y1 = max(dens_y),
yref = "y2", line = list(dash = "dot", width = 1))),
updatemenus = list(
list(
type = "buttons",
y = 1.15, x = 0,
buttons = list(
list(label = "Play", method = "animate",
args = list(NULL, list(frame = list(duration = 400, redraw = FALSE),
transition = list(duration = 0), fromcurrent = TRUE, mode = "immediate"))),
list(label = "Pause", method = "animate",
args = list(NULL, list(mode = "immediate", frame = list(duration = 0, redraw = FALSE), transition = list(duration = 0))))
)
)
),
sliders = list(list(
pad = list(t = 50),
currentvalue = list(prefix = "draw: "),
steps = lapply(seq_len(nrow(stats)), function(k) {
list(method = "animate", label = as.character(k),
args = list(list(as.character(k)),
list(mode = "immediate", frame = list(duration = 0, redraw = FALSE), transition = list(duration = 0))))
})
))
) |>
plotly::animation_opts(frame = 400, transition = 0, redraw = FALSE) |>
plotly::animation_slider(currentvalue = list(prefix = "draw: "))

p$x$frames <- frames
p
```
---

class: middle

# Wrapping Up...

---

class: middle

# Practicalities

---

# What's needed to compute CIs?

- Standard error of the mean (SE)
  - How much will this statistic vary from sample to sample, on average? 
- As N increases $\rightarrow$ SE decreases $\rightarrow$ CI narrows
--

- Confidence % (you set this)
  - 95%, then look at ± 1.96 SEs
  - 99%, then look at ± 2.58 SEs


---

## Interpreting CIs

- In results, will generally report lower and upper CIs:

> “Mean IQ score was 136, 95% CI [130, 142].”

---

```{r echo=FALSE, out.width="75%", fig.align = "center"}
knitr::include_graphics("../img/CIfigure.PNG")
```

--

- There's an important link between CIs and statistical significance
--

- $H_{0}$: r = 0
--

- Sig test: How unusual this observed r is
  - assuming r = 0?
--

- If p $\lt$ .05, 
  - reject $H_{0}$
---

```{r echo=FALSE, out.width="75%", fig.align = "center"}
knitr::include_graphics("../img/CIfigure.PNG")
```


- There's an important link between CIs and statistical significance
- $H_{0}$: r = 0
--

- CI: Are we 95%+ confident that r is not 0?
--

- If 95% CI does not include 0
  - reject $H_{0}$


---

```{r echo=FALSE, out.width="75%", fig.align = "center"}
knitr::include_graphics("../img/CIfigure.PNG")
```


- There's an important link between CIs and statistical significance
--

- We can say:
> “…the 95% CI does not contain zero, and so X and Y were positively correlated.”

---


```{r echo=FALSE, out.width="75%", fig.align = "center"}
knitr::include_graphics("../img/CIfigurens.PNG")
```

- There's an important link between CIs and statistical significance
--

- We can say:
> “…the 95% CI contains zero and so the correlation was not statistically significant…”

---

## Circling back

.pull-left[
- Wake students, n = 100; MIQ = 136
- American population, MIQ = 98
- Are Wake students different than the American pop.? 
]
--
.pull-right[
- How unusual would 136 IQ in the sample,
  - assuming MWFU-IQ = MUSA-IQ?
- Is p < .05?

.hand-pink[OR?]

- What is the 95% CI for MWFU-IQ?
  - Does it include 98?
]

---


# Wrapping Up...
